<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Using Azure Key Vault references with Azure Functions or App Service | Joao Grassi's blog</title><meta name=keywords content="asp.net-core,azure,key-vault,appservice,functions"><meta name=description content="Learn how to integrate Azure Key Vault with your existing apps running in azure without modifying code by using the new Key Vault references feature."><meta name=author content="Joao Grassi"><link rel=canonical href=https://blog.joaograssi.com/using-azure-key-vault-references-with-azure-functions-appservice/><link href=https://blog.joaograssi.com/assets/css/stylesheet.min.ad3c9feff2635cbeec1afaf551499579aea970ed57152b4b8eb70d9e0c002bbd.css integrity="sha256-rTyf7/JjXL7sGvr1UUmVea6pcO1XFStLjrcNngwAK70=" rel="preload stylesheet" as=style><link rel=icon href=https://blog.joaograssi.com/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://blog.joaograssi.com/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://blog.joaograssi.com/favicon-32x32.png><link rel=apple-touch-icon href=https://blog.joaograssi.com/apple-touch-icon.png><link rel=mask-icon href=https://blog.joaograssi.com/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><meta name=generator content="Hugo 0.76.5"><meta property="og:title" content="Using Azure Key Vault references with Azure Functions or App Service"><meta property="og:description" content="Learn how to integrate Azure Key Vault with your existing apps running in azure without modifying code by using the new Key Vault references feature."><meta property="og:type" content="article"><meta property="og:url" content="https://blog.joaograssi.com/using-azure-key-vault-references-with-azure-functions-appservice/"><meta property="og:image" content="https://blog.joaograssi.com/content/images/2019/12/post-header.fw-1.png"><meta property="article:published_time" content="2019-08-25T17:08:00+00:00"><meta property="article:modified_time" content="2019-08-25T17:08:00+00:00"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://blog.joaograssi.com/content/images/2019/12/post-header.fw-1.png"><meta name=twitter:title content="Using Azure Key Vault references with Azure Functions or App Service"><meta name=twitter:description content="Learn how to integrate Azure Key Vault with your existing apps running in azure without modifying code by using the new Key Vault references feature."><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Using Azure Key Vault references with Azure Functions or App Service","name":"Using Azure Key Vault references with Azure Functions or App Service","description":"TL;DR: If you are already familiar with Azure Key Vault, App Service/Functions and just want to know how to use the new Key Vault references feature in your app, you can just jump ‚Ä¶","keywords":["asp.net-core","azure","key-vault","appservice","functions"],"articleBody":"TL;DR: If you are already familiar with Azure Key Vault, App Service/Functions and just want to know how to use the new Key Vault references feature in your app, you can just jump to this section: Create a system-assigned identity for our Function and follow from there.\nASP.NET Core + Configuration By now, it‚Äôs not big news that ASP.NET Core is the future of web development with .NET. Of all the great additions that ASP.NET Core has introduced, one of my favorites is everything around Configuration.\nConfiguration is easy and practical ‚Äî configuring our apps in ASP.NET Core feels natural. I could spend this entire blog post just talking about why I think it‚Äôs so great, but let‚Äôs leave it for maybe another post. :)\nOne thing missing from Configuration is a way to ‚Äúsecure‚Äù the settings. If you use Azure App Service, the settings and connection strings are stored encrypted in Azure, and they are decrypted only before being injected into your app‚Äôs process memory when the app starts, as explained here.\nThis is all great, but one could argue that the settings values are still visible in plain text in the Configurations page on the App Service, and anyone who can access your App Service could potentially see the values. As a practical person, I argue back that if someone you don‚Äôt trust has access to your App Service configurations page, then you probably have more serious issues. ü§∑\nStill, let‚Äôs say you trust no one and you want to have more control over the settings which contain sensitive values in your App Service / Function app settings. Imagine settings like API Keys, external services secrets and so on. How can we achieve a more fine grained control over our settings? Enter Azure Key Vault.\nAzure Key Vault - What is it? The official definition by Microsoft:\n Azure Key Vault is a tool for securely storing and accessing secrets. A secret is anything that you want to tightly control access to, such as API keys, passwords, or certificates. A vault is logical group of secrets.\n In essence, we can think of Azure Key vault as, well a Vault! You put your secret things in, and the vault keeps them secure. Of course, Azure Key Vault is more complex than that and offers many features, but for the scope of this post, I‚Äôd say that‚Äôs enough to understand. Feel free to dig more into the details in case you are interested: What is Azure Key Vault?\nUsing Azure Key Vault with your ASP.NET Core apps If you want to use Azure Key Vault as one of your app‚Äôs configuration providers you would need to do some work, like add specific NuGet packages, get the URL of the Vault, create your clientId and secret (more on resolve this chicken-or-egg issue with Azure system-assigned identity later), connect to the vault, read the settings‚Ä¶ you get the idea.\nThe point is: the process isn‚Äôt trivial. I had to go through these steps recently, and I spent more time on it than I‚Äôm proud to share. Several Microsoft docs and blog posts later, I managed to change my app to make it work. BUT, not everyone out there can change their apps that easily. We need to consider the number of people running critical components in production. Requiring such code changes just for the sake of consuming settings from the Key Vault seems a bit too much to ask.\nAs you maybe guessed at this point, there‚Äôs an easier way (if you are using App Service/Azure Functions at least): Azure Key Vault references. üîê\nAzure Key Vault references With Key Vault references you can reference your secrets from the Key Vault directly in your normal app settings, be it either an app hosted on App Service or an Azure Function. So, your app can just work as it normally would. You don‚Äôt need to change code to be able to use settings that are stored in the Key Vault!\nI should point out that at the time of writing this blog post, this feature is in public preview and only works for App Service and Azure Functions. I suspect that the syntax will not change that much, but we all know that preview is preview and not suitable to use in production.\nUpdate (Dec 2019): Things moved and Key Vault references is out of preview and can be used now in prod apps!\nNow that we know the theory behind Key Vault references and understand the issue it tries to solve, let‚Äôs see how we can actually use this thing in combination with an Azure Function! ‚ö°\nSteps of our demo  Create a Key Vault on Azure Add a new secret ‚Äúsetting‚Äù into our vault Get the ‚Äúreference‚Äù of our secret Create a new Azure Function App on Azure Create an HTTP Function and deploy to Azure Create a system-assigned identity for our Function Configure the access policy in our Key Vault for our Function (GET only) Use the Key Vault reference as the source of our Function setting  Eight steps seem like a lot, but it‚Äôs not that complicated. I will try to guide you and explain each step in more detail, so you are not just blindly following me.\nCreating the Key Vault  On the Azure Portal, go to Resource groups  _your resource group_  Add new resource  Key Vault  Create.\n Fill in the basic details: Name, Region and pricing tier You can skip the other tabs for now. We will come back to Access policy later Review the things and finally click on Create.  Creating our Key Vault  Adding a secret to our Key Vault  Navigate to your Key Vault when the deployment finishes. Once inside the Key Vault page, look at the left menu and click: Secrets  Generate/Import. Enter whatever value you want for your secret and hit the Create button. The page looks like this:\nCreating our secret setting inside the Key Vault  Get the ‚Äúreference‚Äù of our secret  After the secret is created, you are redirected to the list of secrets. Click on the secret you just created. The next page shows the versions of that secret. I will not go into details about this, but a secret can have multiple versions in the Key Vault. We only have one version, so click on that. The steps look more or less like this:\nNavigating to our recently created secret  Once inside the details of that version of the secret, you‚Äôll see the Secret Identifier (it‚Äôs just a URL). That‚Äôs the identifier we will be using later. Azure nicely offers to copy it to the clipboard for us. So, copy it and store it somewhere.\nGetting the reference of our secret from the vault  Create a new Azure Function App  Go to your resource group and add a new resource. Choose Function App. Just fill in the details, and make sure to select .NET Core for runtime stack.\nCreating our Azure Function App  Now we have our Function App created on Azure. A Function App is not the function (code) itself, but more of an aggregator of actual functions. This is nice because it makes deployment, management and resource sharing easier.\nCreate an HTTP Function (v2)  On the Function App page, click on Get publish profile and save it somewhere on your computer. To make this short, we‚Äôll be deploying our Function via Visual Studio, but, for the sake of mankind, don‚Äôt do this for real apps!. This is just a demo.\nContinuing, I‚Äôll create an HTTP Function v2 with .NET Core 2.2. I‚Äôll be using VS 2019 as my IDE, but you can create it with VSCode or VS 2017 as well. You can follow the official docs here on how to create yours: Create your first function OR you could just create the function directly in the Portal for brevity (and avoid having to deploy). Create your first function in the Azure portal\nWhichever way you have chosen to create your function, here is the code for it:\nusing System.Threading.Tasks; using Microsoft.AspNetCore.Mvc; using Microsoft.Azure.WebJobs; using Microsoft.Azure.WebJobs.Extensions.Http; using Microsoft.AspNetCore.Http; using Microsoft.Extensions.Logging; using Microsoft.Extensions.Configuration; namespace FnReadSecretFromVault { public static class Function1 { [FunctionName(\"Function1\")] public static async Task Run( [HttpTrigger(AuthorizationLevel.Function, \"get\", Route = null)] HttpRequest req, ExecutionContext context) { // Set up the configuration builder, the same as in an ASP.NET Core App  var config = new ConfigurationBuilder() .SetBasePath(context.FunctionAppDirectory) .AddJsonFile(\"local.settings.json\", optional: true, reloadOnChange: true) .AddEnvironmentVariables() .Build(); // Access our secret setting, normally as any other setting  var secretSetting = config[\"MySecretSetting\"]; return new OkObjectResult(secretSetting); } } } The only thing it does is: Grab the configuration, access the value of our secret setting and return it.\n If you are not familiar with how settings work in App Service or Azure Functions: the settings configured in the Azure portal are available as environment variables into our apps. So the call to AddEnvironmentVariables makes sure our app has them loaded as one of our providers.\n Another thing to note is the local.settings.json file:\n{ \"IsEncrypted\": false, \"Values\": { \"AzureWebJobsStorage\": \"\", \"FUNCTIONS_WORKER_RUNTIME\": \"dotnet\" }, \"MySecretSetting\": \"Local-Value\" } See the MySecretSetting entry there? It holds a local value. If we run the function on our machines, it will return Local-value, as we would expect. Pretty straightforward. Let‚Äôs now deploy this function to Azure.\nDeploying the function to Azure Remember that we downloaded the publish profile before? Now it‚Äôs time to use it. Again, you don‚Äôt need to use Visual Studio for this (and please don‚Äôt!), but, for the sake of brevity, this is what I‚Äôm going to use. There are plenty of tutorials on how to deploy it via PowerShell, Git, Azure Pipelines, and so on.\nOn Visual Studio:\n Right-click on the Function project  Publish In the window click on Import Profile... Once it‚Äôs imported, hit Publish Done!  If we would test our function now, it would run fine, but it wouldn‚Äôt return anything. Why? Because the local.settings.json file is meant to be used only during development. To be able to access the MySecretSetting from our function when it‚Äôs running on Azure, we have to add this setting there. The image below shows how to access the Function settings page:\nAccessing the Settings page of our Function App  In the application settings page, click on New application setting and enter the same key as we have on the local file: MySecretSetting, with a value like: Azure-Value.\nNow we can test our new Function! Go back to the main page and follow the steps on the image (you can open the image in a new tab to see it better).\nTesting our HTTP Function  Our Function now returns: Azure-Value! But it‚Äôs still not what we want. Let‚Äôs continue and change it to return the value stored in the Key Vault, using references.\nCreating a system-assigned identity for our Function  To be able to consume the secrets from the Key Vault, our Function needs to have access to it. In Azure, you can configure one resource to access another by creating what‚Äôs called a managed identity. Once your resource has a managed identity, you can modify another resource and allow access to it. Maybe my explanation sucks, so here are the official words:\n A managed identity from Azure Active Directory allows your app to easily access other AAD-protected resources such as Azure Key Vault. The identity is managed by the Azure platform and does not require you to provision or rotate any secrets.\n This also solves the Chicken or the egg issue where you have to have the Key Vault user and password in your settings before you‚Äôre able to connect to it.\nLet‚Äôs add a managed identity for our Function App:\nConfiguring a managed identity for our Function App  On the new page, make sure the tab System assigned is selected. Then, toggle the Status to On and press Save. That‚Äôs it. Wait until Azure finishes configuring everything to move to the next step.\nConfiguring the access policy on the Key Vault for our Function  One of the nices thing about Azure Key Vault revolves around its access policy feature. The granularity is huge so we can achieve a lot of things by creating several policies with different access levels. In our case, we‚Äôre going to keep it simple and allow only GET access to secrets to our Function.\nThe previous step was important because now we can search for our managed identity and configure its access to the Vault. To do this, go back now to our Key Vault page, and on the left menu click on Access policies.\nOnce in the Access policies page, click on Add access policy. Select Get for the Secret permissions field. Next, click on the Select principal field. A side-bar will appear on the right side of the screen. There you need to search for our managed identity. If you followed along, the name of it is fnReadsSecretSetting which matches the name used for our Function App initially. Click Select on the window. It should look like this at the end:\nConfiguring acess to the Key Vault  Now our Function App has GET access to Secrets in the Vault üëå. The only thing missing now is using the Key Vault references feature, which will allow us to reference the secret in the vault as one of our Function settings. Let‚Äôs move on.\nUsing the Key Vault reference as the source of our Function setting  Now that we have the Key Vault configured to allow access to our Function, let‚Äôs do what we came for (finally!). Remember I told you to copy the secret identifier when we first created the secret in our Key Vault? We are going to use it now. If you lost it or haven‚Äôt copied it yet, don‚Äôt worry. Just go back to your Key Vault  Secrets  Then follow again the instructions on the step: Get the ‚Äúreference‚Äù of our secret.\nThe way the Key Vault references feature work is: It has a special syntax which will contain the secret identifier inside. This is how the syntax looks like:\n@Microsoft.KeyVault(SecretUri=) What you need to do is: Replace the YOUR_SECRET_IDENTIFIER_HERE in the code above with the Secret URI/Identifier we copied from our Key Vault. With our secret reference built, we can head back to our Function Settings (fnReadsSecretSetting  Platform features  Configuration)\nJust edit the MySecretSetting in our Function settings, and paste the reference. Click Ok and make sure to save it!\nUsing the Key Vault reference in our Function settings  Finally, we can invoke our Function and, you should see the value to be the one you entered in your Key Vault!.\nIt might seem like a lot, but let‚Äôs take a step back for a second. Imagine that your app is already in production (Function or App Service) and, with just a few clicks, we were able to reference a setting value which is securely stored and managed by Azure Key Vault, without any code change. Awesome, isn‚Äôt it?\nLimitations: Here are some limitations that you may or may not care:\n  As of it now, you have to use the whole secret URL, with the version at the end. This isn‚Äôt great, because if you change the secret, the AppService/Function will not use the new value. It seems they are working on to support not having to have the version, but there‚Äôs no ETA.\n  The Key Vault references is still in preview, so use it with care. According to this comment the GA might be comming soon. You can also vote and subscribe to this so you are notified when it‚Äôs available for production.\n  Good to know The access to the key vault is priced by transactions. For secrets, the current pricing page shows secrets operations: ‚Ç¨0.026/10,000 transactions.\nWell, that looks pretty cheap. But still, I wouldn‚Äôt like to have a surprise at some point after starting using it. The first thing I was curious was: While using Key Vault references, does it count as a transaction for every time I read the setting which holds the reference value?. Turns out someone already asked it over on GitHub and the response was:\n The settings/values are pulled from KeyVault once the app service process starts [‚Ä¶]\n Here is the link for the whole discussion: KeyVault references - are returned values cached in the App Service\nAutomation I demonstrated here in this post how to configure Key Vault references in your AppService or Function. Along with the post, I created several resources and changed configurations, all via the Azure Portal. It‚Äôs okay to do it like that a few times, but as soon as you need to scale your services you have to start thinking about how to automate the deployment of it. Most of the things I showed here, you can do via the Azure CLI. In case you are interested, the links below have more details on this.\nReferences/links It‚Äôs not possible to cover all the things in a single blog post. If I got you curious/interested, you can go into more details using the links below.\n  Announcement of Key Vault References: https://azure.microsoft.com/en-us/blog/simplifying-security-for-serverless-and-web-apps-with-azure-functions-and-app-service/\n  Key Vault references docs: https://docs.microsoft.com/en-us/azure/app-service/app-service-key-vault-references\n  Managed identities using Azure CLI: https://docs.microsoft.com/en-us/azure/app-service/overview-managed-identity#using-the-azure-cli\n  CLI samples for Azure App Service: https://docs.microsoft.com/en-us/azure/app-service/samples-cli\n  Key Vault docs: https://docs.microsoft.com/en-us/azure/key-vault/\n  And that‚Äôs about it. Thanks for reading it and I hope it was somewhat usefull. Feel free to leave a comment if you have any questions.\n","wordCount":"2905","inLanguage":"en","datePublished":"2019-08-25T17:08:00Z","dateModified":"2019-08-25T17:08:00Z","author":{"@type":"Person","name":"Joao Grassi"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://blog.joaograssi.com/using-azure-key-vault-references-with-azure-functions-appservice/"},"publisher":{"@type":"Organization","name":"Joao Grassi's blog","logo":{"@type":"ImageObject","url":"https://blog.joaograssi.com/favicon.ico"}}}</script></head><body id=top><script>if(localStorage.getItem("pref-theme")==="dark"){document.body.classList.add('dark');}else if(localStorage.getItem("pref-theme")==="light"){document.body.classList.remove('dark')}else if(window.matchMedia('(prefers-color-scheme: dark)').matches){document.body.classList.add('dark');}</script><noscript><style type=text/css>.theme-toggle,.top-link{display:none}</style></noscript><header class=header><nav class=nav><div class=logo><a href=https://blog.joaograssi.com accesskey=h title="Joao Grassi's blog (Alt + H)">Joao Grassi's blog</a>
<span class=logo-switches><span class=theme-toggle title="(Alt + T)"><a id=theme-toggle accesskey=t><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></a></span></span></div><ul class=menu id=menu onscroll=menu_on_scroll()><li><a href=https://blog.joaograssi.com/archives/ title=Archives><span>Archives</span></a></li><li><a href=https://blog.joaograssi.com/tags/ title=Tags><span>Tags</span></a></li><li><a href=https://blog.joaograssi.com/series/ title=Series><span>Series</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><h1 class=post-title>Using Azure Key Vault references with Azure Functions or App Service</h1></header><div class=post-content><h4 id=tldr>TL;DR:<a hidden class=anchor aria-hidden=true href=#tldr>#</a></h4><p>If you are already familiar with Azure Key Vault, App Service/Functions and just want to know how to use the new <a href=https://docs.microsoft.com/en-us/azure/app-service/app-service-key-vault-references>Key Vault references</a> feature in your app, you can just jump to this section: <a href=#creating-system-identity>Create a system-assigned identity for our Function</a> and follow from there.</p><h2 id=aspnet-core--configuration>ASP.NET Core + Configuration<a hidden class=anchor aria-hidden=true href=#aspnet-core--configuration>#</a></h2><p>By now, it&rsquo;s not big news that ASP.NET Core is the future of web development with .NET. Of all the great additions that ASP.NET Core has introduced, one of my favorites is everything around <strong>Configuration</strong>.</p><p>Configuration is easy and practical ‚Äî configuring our apps in ASP.NET Core feels natural. I could spend this entire blog post just talking about why I think it&rsquo;s so great, but let&rsquo;s leave it for maybe another post. :)</p><p>One thing missing from Configuration is a way to &ldquo;secure&rdquo; the settings. If you use Azure App Service, the settings and connection strings are stored encrypted in Azure, and they are decrypted only before being injected into your app&rsquo;s process memory when the app starts, as explained <a href=https://docs.microsoft.com/en-us/azure/app-service/overview-security#application-secrets>here</a>.</p><p>This is all great, but one could argue that the settings values are still visible in plain text in the Configurations page on the App Service, and anyone who can access your App Service could potentially see the values. As a practical person, I argue back that if someone you don&rsquo;t trust has access to your App Service configurations page, then you probably have more serious issues. ü§∑</p><p>Still, let&rsquo;s say you trust no one and you want to have <strong>more control</strong> over the settings which contain sensitive values in your App Service / Function app settings. Imagine settings like API Keys, external services secrets and so on. How can we achieve a more fine grained control over our settings? Enter <strong>Azure Key Vault</strong>.</p><h2 id=azure-key-vault---what-is-it>Azure Key Vault - What is it?<a hidden class=anchor aria-hidden=true href=#azure-key-vault---what-is-it>#</a></h2><p>The official definition by <a href=https://docs.microsoft.com/en-in/azure/key-vault/key-vault-whatis>Microsoft</a>:</p><blockquote><p>Azure Key Vault is a tool for securely storing and accessing secrets. A secret is anything that you want to tightly control access to, such as API keys, passwords, or certificates. A vault is logical group of secrets.</p></blockquote><p>In essence, we can think of Azure Key vault as, well a Vault! You put your secret things in, and the vault keeps them secure. Of course, Azure Key Vault is more complex than that and offers many features, but for the scope of this post, I&rsquo;d say that&rsquo;s enough to understand. Feel free to dig more into the details in case you are interested: <a href=https://docs.microsoft.com/en-in/azure/key-vault/key-vault-whatis>What is Azure Key Vault?</a></p><h2 id=using-azure-key-vault-with-your-aspnet-core-apps>Using Azure Key Vault with your ASP.NET Core apps<a hidden class=anchor aria-hidden=true href=#using-azure-key-vault-with-your-aspnet-core-apps>#</a></h2><p>If you want to use Azure Key Vault as one of your app&rsquo;s configuration providers you would need to do some work, like add specific NuGet packages, get the URL of the Vault, create your clientId and secret (more on resolve this chicken-or-egg issue with Azure system-assigned identity later), connect to the vault, read the settings&mldr; you get the idea.</p><p>The point is: the process isn‚Äôt trivial. I had to go through these steps recently, and I spent more time on it than I&rsquo;m proud to share. Several Microsoft docs and blog posts later, I managed to change my app to make it work. <em>BUT</em>, not everyone out there can change their apps that easily. We need to consider the number of people running critical components in production. Requiring such code changes just for the sake of consuming settings from the Key Vault seems a bit too much to ask.</p><p>As you maybe guessed at this point, there&rsquo;s an easier way (if you are using App Service/Azure Functions at least): <strong>Azure Key Vault references</strong>. üîê</p><h2 id=azure-key-vault-references>Azure Key Vault references<a hidden class=anchor aria-hidden=true href=#azure-key-vault-references>#</a></h2><p>With Key Vault references you can reference your secrets from the Key Vault directly in your normal app settings, be it either an app hosted on App Service or an Azure Function. So, your app can just work as it normally would. You don&rsquo;t need to change code to be able to use settings that are stored in the Key Vault!</p><p><del>I should point out that at the time of writing this blog post, this feature is in <strong>public preview</strong> and only works for App Service and Azure Functions. I suspect that the syntax will not change that much, but we all know that preview is preview and not suitable to use in production.</del></p><p><strong>Update (Dec 2019)</strong>: Things moved and Key Vault references is out of preview and can be used now in prod apps!</p><p>Now that we know the theory behind Key Vault references and understand the issue it tries to solve, let&rsquo;s see how we can actually use this thing in combination with an Azure Function! ‚ö°</p><h2 id=steps-of-our-demo>Steps of our demo<a hidden class=anchor aria-hidden=true href=#steps-of-our-demo>#</a></h2><ol><li><a href=#creating-key-vault>Create a Key Vault on Azure</a></li><li><a href=#adding-secret-key-vault>Add a new secret &ldquo;setting&rdquo; into our vault</a></li><li><a href=#get-secret-reference>Get the &ldquo;reference&rdquo; of our secret</a></li><li><a href=#creating-function-app>Create a new Azure Function App on Azure</a></li><li><a href=#creating-httpv2-function>Create an HTTP Function and deploy to Azure</a></li><li><a href=#creating-system-identity>Create a system-assigned identity for our Function</a></li><li><a href=#configure-access-policy>Configure the access policy in our Key Vault for our Function (GET only)</a></li><li><a href=#using-reference-in-appsettings>Use the Key Vault reference as the source of our Function setting</a></li></ol><p>Eight steps seem like a lot, but it&rsquo;s not that complicated. I will try to guide you and explain each step in more detail, so you are not just blindly following me.</p><h3 id=creating-the-key-vault-a-idcreating-key-vaulta>Creating the Key Vault <a hidden class=anchor aria-hidden=true href=#creating-the-key-vault-a-idcreating-key-vaulta>#</a></h3><p>On the Azure Portal, go to <code>Resource groups > _your resource group_ > Add new resource > Key Vault > Create</code>.</p><ol><li>Fill in the basic details: Name, Region and pricing tier</li><li>You can skip the other tabs for now. We will come back to <code>Access policy</code> later</li><li>Review the things and finally click on <code>Create</code>.</li></ol><figure class=figure-border><img class=img-center src=/using-azure-key-vault-references-with-azure-functions-appservice/keyvault-creation.png alt="Creating our Key Vault" loading=lazy><figcaption class=img-caption>Creating our Key Vault</figcaption></figure><h3 id=adding-a-secret-to-our-key-vault-a-idadding-secret-key-vaulta>Adding a secret to our Key Vault <a hidden class=anchor aria-hidden=true href=#adding-a-secret-to-our-key-vault-a-idadding-secret-key-vaulta>#</a></h3><p>Navigate to your Key Vault when the deployment finishes. Once inside the Key Vault page, look at the left menu and click: <code>Secrets > Generate/Import</code>. Enter whatever value you want for your secret and hit the <code>Create</code> button. The page looks like this:</p><figure class=figure-border><img class=img-center src=/using-azure-key-vault-references-with-azure-functions-appservice/keyvault-secret.png alt="Creating our secret setting inside the Key Vault" loading=lazy><figcaption class=img-caption>Creating our secret setting inside the Key Vault</figcaption></figure><h3 id=get-the-reference-of-our-secret-a-idget-secret-referencea>Get the &ldquo;reference&rdquo; of our secret <a hidden class=anchor aria-hidden=true href=#get-the-reference-of-our-secret-a-idget-secret-referencea>#</a></h3><p>After the secret is created, you are redirected to the list of secrets. Click on the secret you just created. The next page shows the versions of that secret. I will not go into details about this, but a secret can have multiple versions in the Key Vault. We only have one version, so click on that. The steps look more or less like this:</p><figure class=figure-border><img class=img-center src=/using-azure-key-vault-references-with-azure-functions-appservice/keyvault-secret-version.png alt="Navigating to our recently created secret" loading=lazy><figcaption class=img-caption>Navigating to our recently created secret</figcaption></figure><p>Once inside the details of that version of the secret, you&rsquo;ll see the <code>Secret Identifier</code> (it&rsquo;s just a URL). That&rsquo;s the identifier we will be using later. Azure nicely offers to copy it to the clipboard for us. So, copy it and store it somewhere.</p><figure class=figure-border><img class=img-center src=/using-azure-key-vault-references-with-azure-functions-appservice/keyvault-secret-reference.png alt="Getting the reference of our secret from the vault" loading=lazy><figcaption class=img-caption>Getting the reference of our secret from the vault</figcaption></figure><h3 id=create-a-new-azure-function-app-a-idcreating-function-appa>Create a new Azure Function App <a hidden class=anchor aria-hidden=true href=#create-a-new-azure-function-app-a-idcreating-function-appa>#</a></h3><p>Go to your resource group and add a new resource. Choose <code>Function App</code>. Just fill in the details, and make sure to select <code>.NET Core</code> for runtime stack.</p><figure class=figure-border><img class=img-center src=/using-azure-key-vault-references-with-azure-functions-appservice/creating-function-app.png alt="Creating our Azure Function App" loading=lazy><figcaption class=img-caption>Creating our Azure Function App</figcaption></figure><p>Now we have our Function App created on Azure. A Function App is not the function (code) itself, but more of an aggregator of actual functions. This is nice because it makes deployment, management and resource sharing easier.</p><h3 id=create-an-http-function-v2-a-idcreating-httpv2-functiona>Create an HTTP Function (v2) <a hidden class=anchor aria-hidden=true href=#create-an-http-function-v2-a-idcreating-httpv2-functiona>#</a></h3><p>On the Function App page, click on <code>Get publish profile</code> and save it somewhere on your computer. To make this short, we&rsquo;ll be deploying our Function via Visual Studio, but, for the sake of mankind, <strong>don&rsquo;t do this for real apps!</strong>. <em>This is just a demo</em>.</p><p>Continuing, I&rsquo;ll create an <code>HTTP Function v2</code> with <code>.NET Core 2.2</code>. I&rsquo;ll be using VS 2019 as my IDE, but you can create it with VSCode or VS 2017 as well. You can follow the official docs here on how to create yours: <a href=https://docs.microsoft.com/en-us/azure/azure-functions/functions-create-your-first-function-visual-studio>Create your first function</a> <em>OR</em> you could just create the function directly in the Portal for brevity (and avoid having to deploy). <a href=https://docs.microsoft.com/en-us/azure/azure-functions/functions-create-first-azure-function>Create your first function in the Azure portal</a></p><p>Whichever way you have chosen to create your function, here is the code for it:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-csharp data-lang=csharp><span style=color:#66d9ef>using</span> System.Threading.Tasks;
<span style=color:#66d9ef>using</span> Microsoft.AspNetCore.Mvc;
<span style=color:#66d9ef>using</span> Microsoft.Azure.WebJobs;
<span style=color:#66d9ef>using</span> Microsoft.Azure.WebJobs.Extensions.Http;
<span style=color:#66d9ef>using</span> Microsoft.AspNetCore.Http;
<span style=color:#66d9ef>using</span> Microsoft.Extensions.Logging;
<span style=color:#66d9ef>using</span> Microsoft.Extensions.Configuration;

<span style=color:#66d9ef>namespace</span> FnReadSecretFromVault
{
    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>Function1</span>
    {
<span style=color:#a6e22e>        [FunctionName(&#34;Function1&#34;)]</span>
        <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>async</span> Task&lt;IActionResult&gt; Run(
<span style=color:#a6e22e>            [HttpTrigger(AuthorizationLevel.Function, &#34;get&#34;, Route = null)]</span> HttpRequest req,
            ExecutionContext context)
        {
            <span style=color:#75715e>// Set up the configuration builder, the same as in an ASP.NET Core App
</span><span style=color:#75715e></span>            <span style=color:#66d9ef>var</span> config = <span style=color:#66d9ef>new</span> ConfigurationBuilder()
                .SetBasePath(context.FunctionAppDirectory)
                .AddJsonFile(<span style=color:#e6db74>&#34;local.settings.json&#34;</span>, optional: <span style=color:#66d9ef>true</span>, reloadOnChange: <span style=color:#66d9ef>true</span>)
                .AddEnvironmentVariables()
                .Build();

            <span style=color:#75715e>// Access our secret setting, normally as any other setting
</span><span style=color:#75715e></span>            <span style=color:#66d9ef>var</span> secretSetting = config[<span style=color:#e6db74>&#34;MySecretSetting&#34;</span>];

            <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>new</span> OkObjectResult(secretSetting);
        }
    }
}

</code></pre></div><p>The only thing it does is: Grab the configuration, access the value of our secret setting and return it.</p><blockquote><p>If you are not familiar with how settings work in App Service or Azure Functions: the settings configured in the Azure portal are available as environment variables into our apps. So the call to <code>AddEnvironmentVariables</code> makes sure our app has them loaded as one of our providers.</p></blockquote><p>Another thing to note is the <code>local.settings.json</code> file:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript>{
  <span style=color:#e6db74>&#34;IsEncrypted&#34;</span><span style=color:#f92672>:</span> <span style=color:#66d9ef>false</span>,
  <span style=color:#e6db74>&#34;Values&#34;</span><span style=color:#f92672>:</span> {
    <span style=color:#e6db74>&#34;AzureWebJobsStorage&#34;</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;&#34;</span>,
    <span style=color:#e6db74>&#34;FUNCTIONS_WORKER_RUNTIME&#34;</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;dotnet&#34;</span>
  },
  <span style=color:#e6db74>&#34;MySecretSetting&#34;</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;Local-Value&#34;</span>
}
</code></pre></div><p>See the <code>MySecretSetting</code> entry there? It holds a local value. If we run the function on our machines, it will return <code>Local-value</code>, as we would expect. Pretty straightforward. Let&rsquo;s now deploy this function to Azure.</p><h3 id=deploying-the-function-to-azure>Deploying the function to Azure<a hidden class=anchor aria-hidden=true href=#deploying-the-function-to-azure>#</a></h3><p>Remember that we downloaded the publish profile before? Now it&rsquo;s time to use it. Again, you don&rsquo;t need to use Visual Studio for this (and please don&rsquo;t!), but, for the sake of brevity, this is what I&rsquo;m going to use. There are plenty of tutorials on how to deploy it via PowerShell, Git, Azure Pipelines, and so on.</p><p>On Visual Studio:</p><ol><li>Right-click on the Function project > <code>Publish</code></li><li>In the window click on <code>Import Profile...</code></li><li>Once it&rsquo;s imported, hit <code>Publish</code></li><li>Done!</li></ol><p>If we would test our function now, it would run fine, but it wouldn&rsquo;t return anything. Why? Because the <code>local.settings.json</code> file is meant to be used only during development. To be able to access the <code>MySecretSetting</code> from our function when it&rsquo;s running on Azure, we have to add this setting there. The image below shows how to access the Function settings page:</p><figure class=figure-border><img class=img-center src=/using-azure-key-vault-references-with-azure-functions-appservice/adding-app-settings.png alt="Accessing the Settings page of our Function App" loading=lazy><figcaption class=img-caption>Accessing the Settings page of our Function App</figcaption></figure><p>In the application settings page, click on <code>New application setting</code> and enter the same key as we have on the local file: <code>MySecretSetting</code>, with a value like: <code>Azure-Value</code>.</p><p>Now we can test our new Function! Go back to the main page and follow the steps on the image (you can open the image in a new tab to see it better).</p><figure class=figure-border><img class=img-center src=/using-azure-key-vault-references-with-azure-functions-appservice/testing-function.png alt="Testing our HTTP Function" loading=lazy><figcaption class=img-caption>Testing our HTTP Function</figcaption></figure><p>Our Function now returns: <code>Azure-Value</code>! But it&rsquo;s still not what we want. Let&rsquo;s continue and change it to return the value stored in the Key Vault, using references.</p><h2 id=creating-a-system-assigned-identity-for-our-function-a-idcreating-system-identitya>Creating a system-assigned identity for our Function <a hidden class=anchor aria-hidden=true href=#creating-a-system-assigned-identity-for-our-function-a-idcreating-system-identitya>#</a></h2><p>To be able to consume the secrets from the Key Vault, our Function needs to have access to it. In Azure, you can configure one resource to access another by creating what&rsquo;s called a <a href=https://docs.microsoft.com/en-us/azure/active-directory/managed-identities-azure-resources/overview>managed identity</a>. Once your resource has a managed identity, you can modify another resource and allow access to it. Maybe my explanation sucks, so here are the official words:</p><blockquote><p>A managed identity from Azure Active Directory allows your app to easily access other AAD-protected resources such as Azure Key Vault. The identity is managed by the Azure platform and does not require you to provision or rotate any secrets.</p></blockquote><p>This also solves the <em>Chicken or the egg</em> issue where you have to have the Key Vault <code>user</code> and <code>password</code> in your settings before you&rsquo;re able to connect to it.</p><p>Let&rsquo;s add a managed identity for our Function App:</p><figure class=figure-border><img class=img-center src=/using-azure-key-vault-references-with-azure-functions-appservice/adding-managed-identity.png alt="Configuring a managed identity for our Function App" loading=lazy><figcaption class=img-caption>Configuring a managed identity for our Function App</figcaption></figure><p>On the new page, make sure the tab <code>System assigned</code> is selected. Then, toggle the <code>Status</code> to <code>On</code> and press <code>Save</code>. That&rsquo;s it. Wait until Azure finishes configuring everything to move to the next step.</p><h2 id=configuring-the-access-policy-on-the-key-vault-for-our-function-a-idconfigure-access-policya>Configuring the access policy on the Key Vault for our Function <a hidden class=anchor aria-hidden=true href=#configuring-the-access-policy-on-the-key-vault-for-our-function-a-idconfigure-access-policya>#</a></h2><p>One of the nices thing about Azure Key Vault revolves around its access policy feature. The granularity is huge so we can achieve a lot of things by creating several policies with different access levels. In our case, we&rsquo;re going to keep it simple and allow only <code>GET</code> access to secrets to our Function.</p><p>The previous step was important because now we can search for our managed identity and configure its access to the Vault. To do this, go back now to our Key Vault page, and on the left menu click on <code>Access policies</code>.</p><p>Once in the <code>Access policies</code> page, click on <code>Add access policy</code>. Select <code>Get</code> for the <code>Secret permissions</code> field. Next, click on the <code>Select principal</code> field. A side-bar will appear on the right side of the screen. There you need to search for our managed identity. If you followed along, the name of it is <code>fnReadsSecretSetting</code> which matches the name used for our Function App initially. Click <code>Select</code> on the window. It should look like this at the end:</p><figure class=figure-border><img class=img-center src=/using-azure-key-vault-references-with-azure-functions-appservice/adding-accesspolicy.png alt="Configuring acess to the Key Vault" loading=lazy><figcaption class=img-caption>Configuring acess to the Key Vault</figcaption></figure><p>Now our Function App has <code>GET</code> access to <code>Secrets</code> in the Vault üëå. The only thing missing now is using the <code>Key Vault references</code> feature, which will allow us to reference the secret in the vault as one of our Function settings. Let&rsquo;s move on.</p><h2 id=using-the-key-vault-reference-as-the-source-of-our-function-setting-a-idusing-reference-in-appsettingsa>Using the Key Vault reference as the source of our Function setting <a hidden class=anchor aria-hidden=true href=#using-the-key-vault-reference-as-the-source-of-our-function-setting-a-idusing-reference-in-appsettingsa>#</a></h2><p>Now that we have the Key Vault configured to allow access to our Function, let&rsquo;s do what we came for (finally!). Remember I told you to copy the <strong>secret identifier</strong> when we first created the secret in our Key Vault? We are going to use it now. If you lost it or haven&rsquo;t copied it yet, don&rsquo;t worry. Just go back to your Key Vault > Secrets > Then follow again the instructions on the step: <a href=#get-secret-reference>Get the &ldquo;reference&rdquo; of our secret</a>.</p><p>The way the Key Vault references feature work is: It has a special syntax which will contain the secret identifier inside. This is how the syntax looks like:</p><pre><code>@Microsoft.KeyVault(SecretUri=&lt;YOUR_SECRET_IDENTIFIER_HERE&gt;)
</code></pre><p>What you need to do is: Replace the <strong>YOUR_SECRET_IDENTIFIER_HERE</strong> in the code above with the Secret URI/Identifier we copied from our Key Vault. With our secret reference built, we can head back to our Function Settings (<code>fnReadsSecretSetting</code> > <code>Platform features</code> > <code>Configuration</code>)</p><p>Just edit the <code>MySecretSetting</code> in our Function settings, and paste the reference. Click <code>Ok</code> and make sure to save it!</p><figure class=figure-border><img class=img-center src=/using-azure-key-vault-references-with-azure-functions-appservice/adding-secret-ref.png alt="Using the Key Vault reference in our Function settings" loading=lazy><figcaption class=img-caption>Using the Key Vault reference in our Function settings</figcaption></figure><p>Finally, we can invoke our Function and, you should see the value to be the one you entered in your Key Vault!.</p><p>It might seem like a lot, but let&rsquo;s take a step back for a second. Imagine that your app is already in production (Function or App Service) and, with just a few clicks, we were able to reference a setting value which is securely stored and managed by Azure Key Vault, without any code change. Awesome, isn&rsquo;t it?</p><h2 id=limitations>Limitations:<a hidden class=anchor aria-hidden=true href=#limitations>#</a></h2><p>Here are some limitations that you may or may not care:</p><ol><li><p>As of it now, you have to use the whole secret URL, with the version at the end. This isn&rsquo;t great, because if you change the secret, the AppService/Function will not use the new value. <a href=https://azure.microsoft.com/en-us/blog/simplifying-security-for-serverless-and-web-apps-with-azure-functions-and-app-service/#comment-4380282345>It seems they are working on to support not having to have the version, but there&rsquo;s no ETA</a>.</p></li><li><p>The Key Vault references is still in preview, so use it with care. According to <a href=https://azure.microsoft.com/en-us/blog/simplifying-security-for-serverless-and-web-apps-with-azure-functions-and-app-service/#comment-4457246427>this comment</a> the GA might be comming soon. You can also vote and subscribe <a href=https://feedback.azure.com/forums/355860-azure-functions/suggestions/14634717-add-binding-to-key-vault>to this</a> so you are notified when it&rsquo;s available for production.</p></li></ol><h2 id=good-to-know>Good to know<a hidden class=anchor aria-hidden=true href=#good-to-know>#</a></h2><p>The access to the key vault is priced by <em>transactions</em>. For secrets, the current pricing page shows <code>secrets operations: ‚Ç¨0.026/10,000 transactions</code>.</p><p>Well, that looks pretty cheap. But still, I wouldn&rsquo;t like to have a surprise at some point after starting using it. The first thing I was curious was:
<strong>While using Key Vault references, does it count as a transaction for every time I read the setting which holds the reference value?</strong>. Turns out someone already asked it over on GitHub and the response was:</p><blockquote><p>The settings/values are pulled from KeyVault once the app service process starts [&mldr;]</p></blockquote><p>Here is the link for the whole discussion: <a href=https://github.com/MicrosoftDocs/azure-docs/issues/36650#issuecomment-519241267>KeyVault references - are returned values cached in the App Service</a></p><h2 id=automation>Automation<a hidden class=anchor aria-hidden=true href=#automation>#</a></h2><p>I demonstrated here in this post how to configure Key Vault references in your AppService or Function. Along with the post, I created several resources and changed configurations, all via the Azure Portal. It&rsquo;s okay to do it like that a few times, but as soon as you need to scale your services you have to start thinking about how to automate the deployment of it. Most of the things I showed here, you can do via the Azure CLI. In case you are interested, the links below have more details on this.</p><h2 id=referenceslinks>References/links<a hidden class=anchor aria-hidden=true href=#referenceslinks>#</a></h2><p>It&rsquo;s not possible to cover all the things in a single blog post. If I got you curious/interested, you can go into more details using the links below.</p><ul><li><p>Announcement of Key Vault References: <a href=https://azure.microsoft.com/en-us/blog/simplifying-security-for-serverless-and-web-apps-with-azure-functions-and-app-service/>https://azure.microsoft.com/en-us/blog/simplifying-security-for-serverless-and-web-apps-with-azure-functions-and-app-service/</a></p></li><li><p>Key Vault references docs: <a href=https://docs.microsoft.com/en-us/azure/app-service/app-service-key-vault-references>https://docs.microsoft.com/en-us/azure/app-service/app-service-key-vault-references</a></p></li><li><p>Managed identities using Azure CLI: <a href=https://docs.microsoft.com/en-us/azure/app-service/overview-managed-identity#using-the-azure-cli>https://docs.microsoft.com/en-us/azure/app-service/overview-managed-identity#using-the-azure-cli</a></p></li><li><p>CLI samples for Azure App Service: <a href=https://docs.microsoft.com/en-us/azure/app-service/samples-cli>https://docs.microsoft.com/en-us/azure/app-service/samples-cli</a></p></li><li><p>Key Vault docs: <a href=https://docs.microsoft.com/en-us/azure/key-vault/>https://docs.microsoft.com/en-us/azure/key-vault/</a></p></li></ul><p>And that&rsquo;s about it. Thanks for reading it and I hope it was somewhat usefull. Feel free to leave a comment if you have any questions.</p></div><footer class=post-footer><ul class=post-tags><li><a href=https://blog.joaograssi.com/tags/asp.net-core/>asp.net-core</a></li><li><a href=https://blog.joaograssi.com/tags/azure/>azure</a></li><li><a href=https://blog.joaograssi.com/tags/key-vault/>key-vault</a></li><li><a href=https://blog.joaograssi.com/tags/appservice/>appservice</a></li><li><a href=https://blog.joaograssi.com/tags/functions/>functions</a></li></ul></footer></article></main><footer class=footer><span>&copy; 2021 <a href=https://blog.joaograssi.com>Joao Grassi's blog</a></span>
<span>&#183;</span>
<span>Powered by <a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a></span>
<span>&#183;</span>
<span>Theme <a href=https://git.io/hugopapermod rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)"><button class=top-link id=top-link type=button accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6"><path d="M12 6H0l6-6z"/></svg></button></a>
<script defer src=https://blog.joaograssi.com/assets/js/highlight.min.27cd435cc9ed6abb4b496581b151804f79f366c412620272bb94e2f5f598ebcc.js integrity="sha256-J81DXMntartLSWWBsVGAT3nzZsQSYgJyu5Ti9fWY68w=" onload=hljs.initHighlightingOnLoad();></script><script>window.onload=function(){if(localStorage.getItem("menu-scroll-position")){document.getElementById('menu').scrollLeft=localStorage.getItem("menu-scroll-position");}}
document.querySelectorAll('a[href^="#"]').forEach(anchor=>{anchor.addEventListener("click",function(e){e.preventDefault();var id=this.getAttribute("href").substr(1);document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({behavior:"smooth"});if(id==="top"){history.replaceState(null,null," ");}else{history.replaceState(null,null,`#${id}`);}});});var mybutton=document.getElementById("top-link");window.onscroll=function(){if(document.body.scrollTop>800||document.documentElement.scrollTop>800){mybutton.style.visibility="visible";mybutton.style.opacity="1";}else{mybutton.style.visibility="hidden";mybutton.style.opacity="0";}};function menu_on_scroll(){localStorage.setItem("menu-scroll-position",document.getElementById('menu').scrollLeft);}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{if(document.body.className.includes("dark")){document.body.classList.remove('dark');localStorage.setItem("pref-theme",'light');}else{document.body.classList.add('dark');localStorage.setItem("pref-theme",'dark');}})</script></body></html>